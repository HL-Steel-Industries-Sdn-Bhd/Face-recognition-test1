<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8" />
<title>Face Sign In</title>
<script defer src="https://cdn.jsdelivr.net/npm/face-api.js"></script>
<style>
body { font-family: Arial; text-align:center; margin-top:20px; }
#video { width: 300px; border-radius:10px; }
</style>
</head>
<body>

<h2>会议签到（人脸识别）</h2>
<video id="video" autoplay muted></video><br><br>

<form id="sendForm" method="post" action="https://script.google.com/macros/s/AKfycbz_0yF6MzRAFdTHv8fZ2Pd-2cGY9yEWSGVoUtw2LMAeEf1_YP5bGc4XW8IJCBg7lZ0C/exec">
    <input type="hidden" name="name" id="nameField">
    <input type="hidden" name="timestamp" id="timeField">
</form>

<script>
// ===============================
// 贴你的 embedding 在这里
// ===============================
const KNOWN_DATA = [
{
  "name": "TEST_USER",
  "timestamp": "2025-12-10T02:05:35.623Z",
  "embedding_size": 128,
  "embedding": [
    -0.05642962455749512,
    0.04431127384305,
    0.04413426294922829,
    -0.00018732847820501775,
    -0.05275483801960945,
    -0.038819026201963425,
    -0.04423725977540016,
    -0.12826141715049744,
    0.16377253830432892,
    -0.13966824114322662,
    0.24152415990829468,
    -0.04813845828175545,
    -0.21870076656341553,
    -0.040250781923532486,
    -0.07993944734334946,
    0.15969733893871307,
    -0.15694309771060944,
    -0.05907618999481201,
    -0.028073184192180634,
    -0.058422986418008804,
    0.13640494644641876,
    0.033864427357912064,
    -0.00280568515881896,
    0.019015267491340637,
    -0.09480645507574081,
    -0.29768991470336914,
    -0.11341990530490875,
    -0.06861413270235062,
    0.02217993512749672,
    -0.032554998993873596,
    -0.0568804070353508,
    0.027847476303577423,
    -0.14916209876537323,
    -0.06389963626861572,
    0.023537110537290573,
    0.09455261379480362,
    -0.07376913726329803,
    -0.08504215627908707,
    0.16713614761829376,
    -0.035515833646059036,
    -0.1746363341808319,
    0.0020098190288990736,
    0.042234089225530624,
    0.22058692574501038,
    0.13098874688148499,
    0.11059585958719254,
    -0.006112252827733755,
    -0.13060767948627472,
    0.05769668519496918,
    -0.19460415840148926,
    -0.005529691930860281,
    0.13336479663848877,
    0.06197752431035042,
    0.07284512370824814,
    0.004969439469277859,
    -0.1300382763147354,
    0.058211687952280045,
    0.08330468833446503,
    -0.13890676200389862,
    -0.014642446301877499,
    0.0883953720331192,
    -0.14454641938209534,
    -0.002946821739897132,
    -0.04377439618110657,
    0.2416401505470276,
    0.05878164619207382,
    -0.12457413971424103,
    -0.09507103264331818,
    0.07188207656145096,
    -0.17573678493499756,
    -0.09353325515985489,
    0.023287735879421234,
    -0.11117091029882431,
    -0.20388656854629517,
    -0.30173259973526,
    0.0223651472479105,
    0.45468759536743164,
    0.13246603310108185,
    -0.1273912936449051,
    0.0734434649348259,
    -0.010486746206879616,
    0.010737906210124493,
    0.215236634016037,
    0.1382291167974472,
    -0.0259568989276886,
    0.001018177717924118,
    -0.10045047104358673,
    0.01645039953291416,
    0.2004663646221161,
    -0.09227772802114487,
    -0.03911064192652702,
    0.17356516420841217,
    -0.040295373648405075,
    0.1007903590798378,
    -0.0011010034941136837,
    0.01430574245750904,
    -0.06964791566133499,
    0.063216432929039,
    -0.07447370141744614,
    0.01759633980691433,
    0.09951039403676987,
    -0.002558446256443858,
    0.03194814920425415,
    0.09475325793027878,
    -0.13239334523677826,
    0.09820691496133804,
    -0.018687846139073372,
    -0.010178646072745323,
    0.07432349026203156,
    -0.047027554363012314,
    -0.1493866890668869,
    -0.038813672959804535,
    0.13623489439487457,
    -0.22987231612205505,
    0.18397283554077148,
    0.17612820863723755,
    0.02770189754664898,
    0.16203263401985168,
    0.14504604041576385,
    0.09157605469226837,
    -0.013425509445369244,
    -0.027455512434244156,
    -0.2578074038028717,
    -0.03498180955648422,
    0.11014833301305771,
    -0.01908816024661064,
    0.13313890993595123,
    -0.04187076911330223
  ]
}
];

// 加载模型
async function loadModels() {
    await faceapi.nets.tinyFaceDetector.loadFromUri("https://cdn.jsdelivr.net/npm/face-api.js/weights/");
    await faceapi.nets.faceRecognitionNet.loadFromUri("https://cdn.jsdelivr.net/npm/face-api.js/weights/");
    await faceapi.nets.faceLandmark68Net.loadFromUri("https://cdn.jsdelivr.net/npm/face-api.js/weights/");
}
loadModels();

navigator.mediaDevices.getUserMedia({ video: true }).then(stream => {
    document.getElementById("video").srcObject = stream;
});

function euclidDist(a, b) {
    let s = 0;
    for (let i = 0; i < a.length; i++) {
        let d = a[i] - b[i];
        s += d * d;
    }
    return Math.sqrt(s);
}

async function recognizeLoop() {
    const video = document.getElementById("video");
    const det = await faceapi
        .detectSingleFace(video, new faceapi.TinyFaceDetectorOptions())
        .withFaceLandmarks()
        .withFaceDescriptor();

    if (det) {
        const live = det.descriptor;
        let bestName = "UNKNOWN";
        let bestDist = 999;

        for (const p of KNOWN_DATA) {
            const dist = euclidDist(live, p.embedding);
            if (dist < bestDist) {
                bestDist = dist;
                bestName = p.name;
            }
        }

        if (bestDist < 0.45) {  // 阈值 0.45–0.5 比较稳
            sendSignIn(bestName);
            return;
        }
    }

    setTimeout(recognizeLoop, 300);
}

recognizeLoop();

function sendSignIn(name) {
    document.getElementById("nameField").value = name;
    document.getElementById("timeField").value = new Date().toISOString();

    document.getElementById("sendForm").submit();
    alert("签到成功: " + name);
}
</script>

</body>
</html>
